---
layout: mypost
title: 跨域问题
categories: [前端面试]
---

## 首先我们需要知道的是什么是跨域？

浏览器所识别的`url`常常是：协议://域名/端口，当请求地址与访问地址不一致，则会发生跨域问题。跨域问题是因为浏览器需要遵守同源策略，发出的请求即使成功，但是也是会被浏览器拦截下来。

例： `https://wenn.tech/a.md`

|URL|是否同源|原因|
|:---:|:---:|:---:|
|https://wenn.tech/blog/b.md|true|只有路径不同|
|http://wenn.tech/a.md|flase|协议不同|
|https://wenn.live/a.md|flase|域名不同|
|https://wenn.tech:81/a.md|flase|端口不同|

## 什么是同源策略？

同源策略主要限制从同一个源加载的文档或脚本如何与来自另外一个源的资源进行交互，这是一个用于隔离潜在而已文件的重要安全机制。

## 为什么要有同源策略？

如果缺少了同源策略，浏览器很容易受到XSS\CSFR等攻击。

1. 防御XSS攻击
   xss，即Cross-Site Script，是一种代码注入攻击。XSS的本质是：恶意代码未经过滤，与正常的代码混在一起，浏览器无法辨别哪些脚本是可信的，导致恶意脚本被执行。
  措施：
    ①Content Security Policy
    ②输入内容长度控制
    ③Http-Only Cookie
    ④验证码
2. 防御CSRF攻击
   CSRF,即Cross-Site Request Forgery,是一种劫持受信任用户向服务器发送非预期请求的攻击。
   措施：
   ①同源检测(Origin和Referer Check)
   ②Token验证或双重Token以及配合Samesite Cookie
   ③保证页面的幂等性，后端接口不要再Get页面中做用户操作

## 跨域的解决方案

1. 通过jsonp
2. document.domain + iframe
3. location.hash + iframe
4. windows.name + iframe
5. postMessage
6. CORS
7. nginx代理
8. nodejs中间代理
9. WebSocket协议

### jsonp

jsonp的核心是动态添加`script`标签调用服务器提供的JS脚本，允许用户传递一个callback参数给服务器，然后服务器返回数据时会将这个callback参数作为函数名来包裹住JSON数据，这样客户端就可以随意定制自己的函数来自动处理返回数据了。

jsonp使用简单且兼容性不错，但缺点也明显，仅限于Get请求。

### CORS

普通的跨域请求：服务端设置`Access-Control-Allow-origin`即可，前端无需设置，若要带cookie请求，则前后端都要设置。

目前，所有的浏览器都支持该功能（IE8+：IE8/9需要使用XDomainRequet对象来支持CORS），CORS目前是主流的跨域解决方案。

### ngix代理

通过ngix配置一个代理服务器（域名与domain1相同，但端口不同）做跳板机，反向代理domain2接口，并且可以顺便修改cookie中domain信息，方便当前域cookie写入，实现跨域登录。
